import os
import json
import datetime
import pandas as pd
import random 

configfile: "ParamSearchConfig.yaml"


output_dir = config['outputDir']
data_dir = config['dataDir']
all_cells = os.listdir(data_dir)

census = pd.read_csv('utils/summary.csv')
grid_cells = census[(census['grid'].isin(all_cells))]['grid'].tolist()
n_cells = min(len(grid_cells),config.get('nCells',100))
grid_cells = grid_cells[:n_cells]
verbosePlots = "--verbose" if config.get('verbosePlots',False) else ""

print(config['parameterSets'])
run_ids = expand(
    "n{pset[nprice]}p{pset[pprice]}ch4{pset[ch4price]}n2o{pset[n2oprice]}sed{pset[sedprice]}escale{pset[escale]}",
    pset=config['parameterSets'])
print(run_ids)


print("Running on " + str(len(grid_cells)) + " cells")

rule all:
    input:
        expand(
            output_dir + "{run_id}/plots/initial_land_use.tif",
            run_id = run_ids
        )
    shell:
        "python utils/cleanup.py {output_dir} {run_ids}"

rule plots:
    input:
        output_dir + "{run_id}/agents_25.arrow",
    output:
        output_dir + "{run_id}/plots/initial_land_use.tif",
    shell:  
        "python utils/generate_plots.py --run {output_dir}{wildcards.run_id}/ {verbosePlots}  && echo 'plots done!'"


rule join:
    input:
        expand(
            output_dir +  "{run_id}/{grid_cell}/complete.txt",
            grid_cell = grid_cells,
            run_id = run_ids
        ),
    output:
        output_dir + "{run_id}/agents_25.arrow",
    shell:
        "python utils/aggregate_data.py {output_dir}{wildcards.run_id}/"


rule main:
    input:
        data_dir + "{grid_cell}/hectares_with_data_final.gpkg",
    output:
        output_folder = output_dir + "{run_id}/{grid_cell}/complete.txt",
    params:
        n_price = lambda wildcards: wildcards.run_id.split('n')[1].split('p')[0],
        p_price = lambda wildcards: wildcards.run_id.split('p')[1].split('ch4')[0],
        ch4_price = lambda wildcards: wildcards.run_id.split('ch4')[1].split('n2o')[0],
        n2o_price = lambda wildcards: wildcards.run_id.split('n2o')[1].split('sed')[0],
        sed_price = lambda wildcards: wildcards.run_id.split('sed')[1].split('escale')[0],
        e_scale = lambda wildcards: wildcards.run_id.split('escale')[1],
    shell:
        '''
        julia --project=\".\" main.jl \
        --max-parcels {config[maxParcelsPerCell]} \
        --geodata {data_dir}{wildcards.grid_cell}/hectares_with_data_final.gpkg \
        --output-dir {output_dir}{wildcards.run_id}/{wildcards.grid_cell}/ \
        --log-file {output_dir}{wildcards.run_id}/{wildcards.grid_cell}/error.log \
        --extension-scale {params.e_scale} \
        --NPrice {params.n_price} \
        --PPrice {params.p_price} \
        --SedimentPrice {params.sed_price} \
        --N2OPrice {params.n2o_price} \
        --CH4Price {params.ch4_price} \
        --CO2Price {config[CO2Price]} \
        --sediment-model {config[sedimentModel]} \
        --enable-bolus {config[enableBolus]} \
        --disable-land-use-change {config[disableLUC]} \
        --carbon-growth-path {config[carbonGrowthPath]}
        '''
